name: Pull Books

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: "16"



      - name: Pull books
        run: |
          # Replace the URLs with the actual book source URLs you want to pull
          curl -O https://fastly.jsdelivr.net/gh/mumuceo/file01/202311/1935_9862a49a0063d95f9abc729c15992948.json
          curl -O https://cdn.jsdelivr.net/gh/mumuceo/file01/202310/2948_6d4e3f2cb45e82ab05970a5173e6bd5b.json
        
          # Add more curl commands for additional book sources

      - name: Merge and Write JSON
        run: |
          const fs = require('fs');

          // 读取每个 JSON 文件的内容
          const file1 = fs.readFileSync('file1.json', 'utf8');
          const file2 = fs.readFileSync('file2.json', 'utf8');
          // ...

          // 去除开头的 `[` 和结尾的 `]` 符号
          const content1 = file1.slice(1, -1);
          const content2 = file2.slice(1, -1);
          // ...

          // 将每个文件的内容以逗号分隔拼接在一起
          const mergedContent = `${content1},${content2},...`;

          // 在最终的合并结果的末尾添加一个逗号
          const finalContent = `[${mergedContent},]`;

          // 将合并后的内容写入一个新的 JSON 文件
          fs.writeFileSync('merged.json', finalContent)

      - name: Configure Git
        run: |
         git config --local user.email "${{ secrets.USER_EMAIL }}"
         git config --local user.name "${{ secrets.USER_NAME }}"
         git config --local credential.helper store --file=.git-credentials
         echo "https://github.com/${{ github.repository }}:${{ secrets.REPO_TOKEN }}" > .git-credentials

      - name: Add files to Git
        run: |
          git add .git-credentials
          git add *.json

      - name: Commit and push changes
        run: |
          git commit -m "Merge books"
          git -c credential.helper="store --file=.git-credentials" push
